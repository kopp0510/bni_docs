# 商脈會 App 後端架構圖

## 系統總覽

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                    │
├─────────────────────────────────┬───────────────────────────────────────────┤
│         Mobile App (客端)        │           Admin CMS (後台)                │
│      iOS / Android / Web        │             Web Dashboard                 │
└─────────────────────────────────┴───────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Gateway                                     │
│                         (Nginx / Load Balancer)                             │
│                    - SSL/TLS 終止                                            │
│                    - 請求路由                                                │
│                    - 速率限制                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Backend Application                                  │
│                      (NestJS / Express.js)                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Shared Layer                                  │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │ Guards   │ │ Filters  │ │Interceptor│ │  Utils   │ │   DTO    │  │   │
│  │  │ (認證守衛)│ │(例外過濾)│ │ (攔截器) │ │ (工具類) │ │(資料傳輸)│  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       Business Modules                               │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                   第一階段 - 核心模組                         │    │   │
│  │  │  ┌──────────┐    ┌──────────────┐    ┌──────────────┐       │    │   │
│  │  │  │   Auth   │───▶│ Organization │◀───│    Member    │       │    │   │
│  │  │  │  認證系統 │    │   商會管理    │    │    會員系統   │       │    │   │
│  │  │  │          │    │              │    │              │       │    │   │
│  │  │  │ - 登入   │    │ - 樹狀結構   │    │ - 會員審核   │       │    │   │
│  │  │  │ - JWT    │    │ - 商會CRUD   │    │ - 三種類型   │       │    │   │
│  │  │  │ - Token  │    │ - 層級管理   │    │ - 推薦關係   │       │    │   │
│  │  │  └──────────┘    └──────────────┘    └──────────────┘       │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                   第二階段 - 會員延伸                         │    │   │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐         │    │   │
│  │  │  │    Point     │ │     Shop     │ │   Meeting    │         │    │   │
│  │  │  │   點數系統    │ │    店鋪系統   │ │  交流預約系統  │         │    │   │
│  │  │  │              │ │              │ │              │         │    │   │
│  │  │  │ - 點數增減   │ │ - 店鋪CRUD   │ │ - 1對1預約   │         │    │   │
│  │  │  │ - 積分管理   │ │ - 店鋪類別   │ │ - 確認流程   │         │    │   │
│  │  │  │ - 交易紀錄   │ │ - 交易紀錄   │ │ - 改期管理   │         │    │   │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘         │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                   第三階段 - 活動功能                         │    │   │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐         │    │   │
│  │  │  │    Event     │ │   Donation   │ │   Lottery    │         │    │   │
│  │  │  │   活動系統    │ │   捐贈系統    │ │   抽獎系統    │         │    │   │
│  │  │  │              │ │              │ │              │         │    │   │
│  │  │  │ - 活動CRUD   │ │ - 專案管理   │ │ - 小瑪莉     │         │    │   │
│  │  │  │ - 8種類型    │ │ - 捐贈紀錄   │ │ - 抽獎紀錄   │         │    │   │
│  │  │  │ - 報名管理   │ │ - 獎勵積分   │ │              │         │    │   │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘         │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                   第四階段 - 營運管理                         │    │   │
│  │  │  ┌──────────────┐              ┌──────────────┐              │    │   │
│  │  │  │     CMS      │              │   Billing    │              │    │   │
│  │  │  │   內容管理    │              │   帳務系統    │              │    │   │
│  │  │  │              │              │              │              │    │   │
│  │  │  │ - 廣告輪播   │              │ - 會費管理   │              │    │   │
│  │  │  │ - 小喇叭     │              │ - 帳單核對   │              │    │   │
│  │  │  │ - 公司介紹   │              │ - 付款狀態   │              │    │   │
│  │  │  └──────────────┘              └──────────────┘              │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Data Access Layer                             │   │
│  │                      (Prisma ORM / TypeORM)                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Infrastructure Layer                               │
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  PostgreSQL  │  │    Redis     │  │   AWS S3     │  │   Firebase   │    │
│  │   主資料庫    │  │    快取      │  │   檔案儲存    │  │   推播通知    │    │
│  │              │  │              │  │              │  │   (選用)     │    │
│  │ - 會員資料   │  │ - Session   │  │ - 圖片上傳   │  │              │    │
│  │ - 商會資料   │  │ - 點數快取  │  │ - 廣告圖片   │  │ - Push      │    │
│  │ - 交易紀錄   │  │ - 熱門資料  │  │ - 店鋪圖片   │  │ - 通知      │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


## 模組相依關係圖

```
                    ┌──────────┐
                    │   Auth   │
                    │  認證系統 │
                    └────┬─────┘
                         │
                         ▼
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ Organization │ │    Member    │ │     CMS      │
│   商會管理    │ │    會員系統   │ │   內容管理    │
└──────┬───────┘ └──────┬───────┘ └──────────────┘
       │                │
       │         ┌──────┴──────┐
       │         │             │
       ▼         ▼             ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│    Point     │ │     Shop     │ │   Meeting    │
│   點數系統    │ │    店鋪系統   │ │  交流預約系統  │
└──────┬───────┘ └──────────────┘ └──────────────┘
       │
       ├─────────────────┬─────────────────┐
       │                 │                 │
       ▼                 ▼                 ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│    Event     │ │   Donation   │ │   Lottery    │
│   活動系統    │ │   捐贈系統    │ │   抽獎系統    │
└──────────────┘ └──────────────┘ └──────────────┘
                         │
                         ▼
                 ┌──────────────┐
                 │   Billing    │
                 │   帳務系統    │
                 └──────────────┘
```


## 資料夾結構

```
shangmai-backend/
├── docker/
│   ├── Dockerfile
│   └── docker-compose.yml
│
├── prisma/
│   ├── schema.prisma          # 資料庫 Schema
│   └── migrations/            # 資料庫遷移
│
├── src/
│   ├── main.ts                # 應用程式進入點
│   ├── app.module.ts          # 根模組
│   │
│   ├── config/                # 設定檔
│   │   ├── database.config.ts
│   │   ├── redis.config.ts
│   │   └── jwt.config.ts
│   │
│   ├── shared/                # 共用模組
│   │   ├── guards/            # 認證守衛
│   │   ├── filters/           # 例外過濾器
│   │   ├── interceptors/      # 攔截器
│   │   ├── decorators/        # 自定義裝飾器
│   │   ├── dto/               # 共用 DTO
│   │   └── utils/             # 工具函數
│   │
│   └── modules/               # 業務模組
│       ├── auth/              # 認證系統
│       │   ├── auth.module.ts
│       │   ├── auth.controller.ts
│       │   ├── auth.service.ts
│       │   └── dto/
│       │
│       ├── organization/      # 商會管理
│       │   ├── organization.module.ts
│       │   ├── organization.controller.ts
│       │   ├── organization.service.ts
│       │   └── dto/
│       │
│       ├── member/            # 會員系統
│       │   ├── member.module.ts
│       │   ├── member.controller.ts
│       │   ├── member.service.ts
│       │   └── dto/
│       │
│       ├── point/             # 點數系統
│       │   ├── point.module.ts
│       │   ├── point.controller.ts
│       │   ├── point.service.ts
│       │   └── dto/
│       │
│       ├── shop/              # 店鋪系統
│       │   ├── shop.module.ts
│       │   ├── shop.controller.ts
│       │   ├── shop.service.ts
│       │   └── dto/
│       │
│       ├── meeting/           # 交流預約系統
│       │   ├── meeting.module.ts
│       │   ├── meeting.controller.ts
│       │   ├── meeting.service.ts
│       │   └── dto/
│       │
│       ├── event/             # 活動系統
│       │   ├── event.module.ts
│       │   ├── event.controller.ts
│       │   ├── event.service.ts
│       │   └── dto/
│       │
│       ├── donation/          # 捐贈系統
│       │   ├── donation.module.ts
│       │   ├── donation.controller.ts
│       │   ├── donation.service.ts
│       │   └── dto/
│       │
│       ├── lottery/           # 抽獎系統
│       │   ├── lottery.module.ts
│       │   ├── lottery.controller.ts
│       │   ├── lottery.service.ts
│       │   └── dto/
│       │
│       ├── cms/               # 內容管理
│       │   ├── cms.module.ts
│       │   ├── cms.controller.ts
│       │   ├── cms.service.ts
│       │   └── dto/
│       │
│       └── billing/           # 帳務系統
│           ├── billing.module.ts
│           ├── billing.controller.ts
│           ├── billing.service.ts
│           └── dto/
│
├── test/                      # 測試檔案
│   ├── unit/
│   └── e2e/
│
├── .env.example               # 環境變數範例
├── .gitignore
├── package.json
├── tsconfig.json
└── README.md
```


## 部署架構

```
┌─────────────────────────────────────────────────────────────────┐
│                        Cloud Provider                            │
│                     (AWS / GCP / Azure)                         │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Production Environment                  │  │
│  │                                                           │  │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │  │
│  │  │   Nginx     │    │   Docker    │    │   Docker    │   │  │
│  │  │   (LB)      │───▶│  Container  │    │  Container  │   │  │
│  │  │             │    │   (App 1)   │    │   (App 2)   │   │  │
│  │  └─────────────┘    └─────────────┘    └─────────────┘   │  │
│  │                            │                  │           │  │
│  │                            ▼                  ▼           │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │              Managed Services                      │   │  │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐        │   │  │
│  │  │  │ PostgreSQL│ │   Redis   │ │    S3     │        │   │  │
│  │  │  │  (RDS)    │ │(ElastiCache)│ │  Bucket  │        │   │  │
│  │  │  └───────────┘ └───────────┘ └───────────┘        │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Staging Environment                     │  │
│  │                    (較小規模，單一實例)                      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Development Environment                 │  │
│  │                    (本地 Docker Compose)                   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
