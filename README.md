# 商脈會 App 後端系統規劃

## 專案概述

商脈會 App 是一個商業會員管理平台，提供會員管理、點數交易、活動管理、即時通訊等功能。

## 系統架構總覽

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                    │
├─────────────────────────────────┬───────────────────────────────────────────┤
│         Mobile App (客端)        │           Admin CMS (後台)                │
│      iOS / Android / Web        │             Web Dashboard                 │
└─────────────────────────────────┴───────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Gateway                                     │
│                         (Nginx / Load Balancer)                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Backend Application                                  │
│                           (NestJS + TypeScript)                             │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        核心服務 (Phase 1)                            │   │
│  │  ┌──────────┐    ┌──────────────┐    ┌──────────────┐               │   │
│  │  │   Auth   │───▶│ Organization │◀───│    Member    │               │   │
│  │  │  認證系統 │    │   商會管理    │    │    會員系統   │               │   │
│  │  └──────────┘    └──────────────┘    └──────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        會員延伸 (Phase 2)                            │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                 │   │
│  │  │    Point     │ │     Shop     │ │   Referral   │                 │   │
│  │  │   點數系統    │ │    店鋪系統   │ │   推薦系統    │                 │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        活動功能 (Phase 3)                            │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                 │   │
│  │  │    Event     │ │   Donation   │ │   Lottery    │                 │   │
│  │  │   活動系統    │ │   捐贈系統    │ │   抽獎系統    │                 │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        營運管理 (Phase 4)                            │   │
│  │  ┌──────────────┐              ┌──────────────┐                     │   │
│  │  │     CMS      │              │   Billing    │                     │   │
│  │  │   內容管理    │              │   帳務系統    │                     │   │
│  │  └──────────────┘              └──────────────┘                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        通訊服務 (Phase 5)                            │   │
│  │  ┌──────────────┐              ┌──────────────┐                     │   │
│  │  │     Chat     │              │ Notification │                     │   │
│  │  │   聊天系統    │              │   通知系統    │                     │   │
│  │  └──────────────┘              └──────────────┘                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Infrastructure Layer                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  PostgreSQL  │  │    Redis     │  │  S3/MinIO    │  │   Firebase   │    │
│  │   主資料庫    │  │  快取/Pub-Sub │  │   檔案儲存    │  │   推播(選用)  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 系統模組清單

| 編號 | 模組名稱 | 文件連結 | 複雜度 | 開發階段 |
|------|----------|----------|--------|----------|
| 1 | Auth 認證系統 | [auth.md](./systems/auth.md) | 中 | Phase 1 |
| 2 | Organization 商會管理 | [organization.md](./systems/organization.md) | 中 | Phase 1 |
| 3 | Member 會員系統 | [member.md](./systems/member.md) | 高 | Phase 1 |
| 4 | Point 點數系統 | [point.md](./systems/point.md) | 中 | Phase 2 |
| 5 | Shop 店鋪系統 | [shop.md](./systems/shop.md) | 中 | Phase 2 |
| 6 | Referral 推薦系統 | [referral.md](./systems/referral.md) | 中 | Phase 2 |
| 7 | Event 活動系統 | [event.md](./systems/event.md) | 中 | Phase 3 |
| 8 | Donation 捐贈系統 | [donation.md](./systems/donation.md) | 低 | Phase 3 |
| 9 | Lottery 抽獎系統 | [lottery.md](./systems/lottery.md) | 低 | Phase 3 |
| 10 | CMS 內容管理 | [cms.md](./systems/cms.md) | 低 | Phase 4 |
| 11 | Billing 帳務系統 | [billing.md](./systems/billing.md) | 中 | Phase 4 |
| 12 | Chat 聊天系統 | [chat.md](./systems/chat.md) | 高 | Phase 5 |
| 13 | Notification 通知系統 | [notification.md](./systems/notification.md) | 中 | Phase 5 |

---

## 前端規劃文件

| 文件 | 說明 | 連結 |
|------|------|------|
| Admin CMS 後台管理系統 | React + Ant Design 後台前端規劃 | [admin-cms.md](./admin-cms.md) |

---

## 模組相依關係

```
                    ┌──────────┐
                    │   Auth   │
                    │  認證系統 │
                    └────┬─────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ Organization │ │    Member    │ │     CMS      │
│   商會管理    │ │    會員系統   │ │   內容管理    │
└──────┬───────┘ └──────┬───────┘ └──────────────┘
       │                │
       │    ┌───────────┼───────────┐
       │    │           │           │
       ▼    ▼           ▼           ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│    Point     │ │     Shop     │ │   Referral   │
│   點數系統    │ │    店鋪系統   │ │   推薦系統    │
└──────┬───────┘ └──────────────┘ └──────────────┘
       │
       ├─────────────────┬─────────────────┐
       │                 │                 │
       ▼                 ▼                 ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│    Event     │ │   Donation   │ │   Lottery    │
│   活動系統    │ │   捐贈系統    │ │   抽獎系統    │
└──────────────┘ └──────────────┘ └──────────────┘
                         │
                         ▼
                 ┌──────────────┐
                 │   Billing    │
                 │   帳務系統    │
                 └──────────────┘

┌──────────────┐ ┌──────────────┐
│     Chat     │ │ Notification │  ◀── 獨立通訊服務
│   聊天系統    │ │   通知系統    │      依賴 Auth + Member
└──────────────┘ └──────────────┘
```

---

## 技術棧

| 項目 | 技術選型 |
|------|----------|
| 後端框架 | NestJS (TypeScript) |
| 資料庫 | PostgreSQL |
| ORM | Prisma |
| 快取 | Redis |
| 即時通訊 | Socket.io |
| 檔案儲存 | S3 / MinIO |
| 容器化 | Docker + Docker Compose |
| API 文件 | Swagger |

---

## 專案結構

```
shangmai-backend/
├── docker/
│   ├── Dockerfile
│   └── docker-compose.yml
│
├── prisma/
│   ├── schema.prisma
│   └── migrations/
│
├── src/
│   ├── main.ts
│   ├── app.module.ts
│   │
│   ├── config/
│   │   ├── database.config.ts
│   │   ├── redis.config.ts
│   │   └── jwt.config.ts
│   │
│   ├── shared/
│   │   ├── guards/
│   │   ├── filters/
│   │   ├── interceptors/
│   │   ├── decorators/
│   │   ├── dto/
│   │   └── utils/
│   │
│   └── modules/
│       ├── auth/
│       ├── organization/
│       ├── member/
│       ├── point/
│       ├── shop/
│       ├── referral/
│       ├── event/
│       ├── donation/
│       ├── lottery/
│       ├── cms/
│       ├── billing/
│       ├── chat/
│       └── notification/
│
├── test/
│   ├── unit/
│   └── e2e/
│
├── .env.example
├── package.json
├── tsconfig.json
└── README.md
```

---

## 開發階段規劃

### Phase 1 - 核心服務
- Auth 認證系統
- Organization 商會管理
- Member 會員系統

### Phase 2 - 會員延伸
- Point 點數系統
- Shop 店鋪系統
- Referral 推薦系統

### Phase 3 - 活動功能
- Event 活動系統
- Donation 捐贈系統
- Lottery 抽獎系統

### Phase 4 - 營運管理
- CMS 內容管理
- Billing 帳務系統

### Phase 5 - 通訊服務
- Chat 聊天系統
- Notification 通知系統

---

## 第三方服務整合

| 服務 | 用途 | 方案 |
|------|------|------|
| 金流付款 | 加點充值、會員續費 | 藍新 NewebPay |
| 簡訊驗證 | 手機驗證碼 | 自建 OTP 或第三方簡訊服務 |
| 推播通知 | App 推播 | 自建 WebSocket 或 FCM |
| 檔案儲存 | 圖片上傳 | 自建 MinIO 或 AWS S3 |

---

## Claude Code 多 Agent 開發流程

本專案採用 Claude Code 進行開發，運用多種專門 Agent 協作完成各階段任務。

### 可用 Agent 類型

| Agent | 用途 | 適用場景 |
|-------|------|----------|
| Plan | 軟體架構師 | 設計模組實作計劃、評估技術方案 |
| systems-architect | 系統架構專家 | 架構審查、資料庫設計、系統整合 |
| general-purpose | 通用開發 | 實際撰寫程式碼、功能實作 |
| test-engineer | 測試專家 | 建立測試案例、品質保證、覆蓋率分析 |
| security-auditor | 安全專家 | 安全審查、漏洞評估、OWASP 合規 |
| performance-tuner | 效能專家 | 效能優化、瓶頸分析、查詢優化 |
| refactor-expert | 重構專家 | 程式碼品質改善、技術債務處理 |
| docs-writer | 文件專家 | API 文件、技術文件撰寫 |
| root-cause-analyzer | 除錯專家 | 問題根因分析、複雜 Bug 排查 |
| config-safety-reviewer | 配置審查 | 生產環境配置安全性檢查 |

### 單一模組開發流程

每個模組依照以下流程進行開發：

| 步驟 | Agent | 任務內容 |
|------|-------|----------|
| 1 | Plan | 根據規格文件，規劃模組實作細節 |
| 2 | systems-architect | 審查資料庫 Schema 與 API 設計 |
| 3 | general-purpose | 開發後端 API（NestJS） |
| 4 | general-purpose | 開發後台前端頁面（React） |
| 5 | test-engineer | 建立單元測試與整合測試 |
| 6 | security-auditor | 審查安全性（特別是 Auth、Point、Billing） |
| 7 | performance-tuner | 優化效能（查詢、快取策略） |

### 多 Agent 並行開發策略

#### Phase 1（序列開發）

基礎模組需序列開發，確保架構穩固：

| 順序 | 模組 | 說明 |
|------|------|------|
| 1 | 專案初始化 | 後端 + 前端專案架構建立 |
| 2 | Auth | 認證系統，所有模組依賴 |
| 3 | Member | 會員系統，大部分模組依賴 |
| 4 | Organization | 商會管理 |

#### Phase 2-5（可並行開發）

基礎模組完成後，可依相依性安排多 Agent 並行：

| Agent | 負責模組 | 前置條件 |
|-------|----------|----------|
| Agent A | Point → Shop → Referral | 等待 Member 完成 |
| Agent B | CMS | 等待 Auth 完成（相對獨立） |
| Agent C | Event → Donation → Lottery | 等待 Point 完成 |
| Agent D | Billing | 等待 Point 完成 |
| Agent E | Chat → Notification | 等待 Member 完成 |

### 模組相依性與開發順序

```
Level 0: Auth（最先開發）
    ↓
Level 1: Member, CMS（可並行）
    ↓
Level 2: Organization, Point, Shop, Referral（可並行，依賴 Member）
    ↓
Level 3: Event, Donation, Lottery, Billing（可並行，依賴 Point）
    ↓
Level 4: Chat, Notification（依賴 Member）
```

### 品質保證流程

每個模組完成後，執行以下檢查：

| 檢查項目 | Agent | 內容 |
|----------|-------|------|
| 功能測試 | test-engineer | 單元測試、整合測試、E2E 測試 |
| 安全審查 | security-auditor | 認證、授權、資料驗證、注入防護 |
| 效能檢查 | performance-tuner | 查詢效能、N+1 問題、快取策略 |
| 程式品質 | refactor-expert | 程式碼規範、重複代碼、SOLID 原則 |
| 配置安全 | config-safety-reviewer | 環境變數、敏感資訊、生產配置 |

### 重點模組額外審查

以下模組因涉及金流或安全性，需額外審查：

| 模組 | 額外審查項目 |
|------|--------------|
| Auth | JWT 安全性、Token 過期策略、密碼加密 |
| Point | 交易原子性、餘額一致性、防重複扣款 |
| Billing | 金流串接安全、交易記錄完整性、退款機制 |
| Chat | 訊息加密、連線安全、歷史記錄保護 |
