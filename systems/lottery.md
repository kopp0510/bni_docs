# Lottery 抽獎系統

## 模組資訊

| 項目 | 說明 |
|------|------|
| 模組名稱 | Lottery |
| 開發階段 | Phase 3 |
| 複雜度 | 低 |
| 相依模組 | Auth, Member, Point |
| 被依賴 | 無 |

---

## 功能概述

抽獎系統提供九宮格小瑪莉抽獎功能，會員可使用抽獎機會獲得點數、積分等獎勵。

---

## 功能清單

### 後台功能

| 功能 | 說明 |
|------|------|
| 抽獎記錄列表 | 查看所有抽獎記錄 |
| 時間篩選 | 依時間範圍篩選記錄 |
| 獎品設定 | 設定獎品內容與機率（可選） |

### 客端功能

| 功能 | 說明 |
|------|------|
| 抽獎主頁 | 九宮格抽獎介面 |
| 抽獎次數 | 顯示剩餘抽獎次數 |
| 獎品說明 | 顯示獎品內容 |
| 抽獎動畫 | 抽獎轉動動畫效果 |
| 中獎結果 | 顯示中獎獎品 |

---

## API 端點設計

### 後台 API

**抽獎管理**

| 方法 | 端點 | 說明 |
|------|------|------|
| GET | /api/v1/admin/lottery/records | 抽獎記錄列表 |
| GET | /api/v1/admin/lottery/stats | 抽獎統計 |

**獎品設定（可選）**

| 方法 | 端點 | 說明 |
|------|------|------|
| GET | /api/v1/admin/lottery/prizes | 獎品列表 |
| PUT | /api/v1/admin/lottery/prizes | 更新獎品設定 |

### 客端 API

| 方法 | 端點 | 說明 |
|------|------|------|
| GET | /api/v1/lottery/info | 抽獎資訊（次數、獎品） |
| POST | /api/v1/lottery/draw | 執行抽獎 |
| GET | /api/v1/lottery/records | 我的抽獎記錄 |

---

## 資料庫設計

### 抽獎記錄表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | UUID | 主鍵 |
| memberId | 字串 | 會員 ID |
| prizeType | 列舉 | 獎品類型 |
| prizeValue | 整數 | 獎品數值 |
| prizeName | 字串 | 獎品名稱 |
| note | 字串 | 備註（選填） |
| createdAt | 時間 | 建立時間 |

**獎品類型列舉值：**

| 值 | 說明 |
|------|------|
| LOVE_POINT | 愛心點數 |
| REWARD_POINT | 獎勵積分 |
| NOTHING | 謝謝參與 |

### 獎品設定表（可選）

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | UUID | 主鍵 |
| position | 整數 | 九宮格位置（0-7，唯一） |
| type | 列舉 | 獎品類型 |
| value | 整數 | 獎品數值 |
| name | 字串 | 獎品名稱 |
| icon | 字串 | 獎品圖示（選填） |
| probability | 浮點數 | 中獎機率（0-1） |
| isActive | 布林 | 是否啟用（預設 true） |
| createdAt | 時間 | 建立時間 |
| updatedAt | 時間 | 更新時間 |

### 會員抽獎次數表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | UUID | 主鍵 |
| memberId | 字串 | 會員 ID（唯一） |
| dailyQuota | 整數 | 每日抽獎次數（預設 1） |
| remainingToday | 整數 | 今日剩餘次數（預設 1） |
| lastResetAt | 時間 | 上次重置時間 |
| totalDraws | 整數 | 總抽獎次數（預設 0） |
| updatedAt | 時間 | 更新時間 |

---

## 業務邏輯

### 九宮格獎品配置（預設）

| 位置 | 獎品名稱 | 類型 | 數值 | 機率 |
|------|----------|------|------|------|
| 0 | 10 愛心點 | LOVE_POINT | 10 | 15% |
| 1 | 50 愛心點 | LOVE_POINT | 50 | 8% |
| 2 | 100 愛心點 | LOVE_POINT | 100 | 3% |
| 3 | 10 積分 | REWARD_POINT | 10 | 15% |
| 4 | 50 積分 | REWARD_POINT | 50 | 8% |
| 5 | 100 積分 | REWARD_POINT | 100 | 3% |
| 6 | 謝謝參與 | NOTHING | 0 | 24% |
| 7 | 謝謝參與 | NOTHING | 0 | 24% |

### 抽獎流程

| 步驟 | 說明 |
|------|------|
| 1 | 檢查會員抽獎次數 |
| 2 | 若次數 > 0，執行抽獎 |
| 3 | 根據機率隨機選擇獎品 |
| 4 | 發放獎品（點數/積分） |
| 5 | 扣除抽獎次數 |
| 6 | 建立抽獎記錄 |
| 7 | 返回抽獎結果（含動畫位置） |

### 機率抽獎演算法

| 步驟 | 說明 |
|------|------|
| 1 | 計算所有獎品總機率 |
| 2 | 生成隨機數（0 到總機率之間） |
| 3 | 依序扣除各獎品機率 |
| 4 | 當隨機數 <= 0 時，該獎品為中獎結果 |
| 5 | 若未中獎則返回最後一個獎品（謝謝參與） |

### 抽獎次數規則

| 規則 | 說明 |
|------|------|
| 每日次數 | 每人每日 1 次（可調整） |
| 重置時間 | 每日 00:00 重置 |
| 額外獲取 | 可透過活動獲得額外次數 |

### 每日重置邏輯

| 步驟 | 說明 |
|------|------|
| 1 | 檢查會員上次重置時間 |
| 2 | 若上次重置時間早於今日 00:00 |
| 3 | 將剩餘次數重置為每日配額 |
| 4 | 更新上次重置時間為現在 |

---

## DTO 資料格式

### 抽獎資訊回應

| 欄位 | 類型 | 說明 |
|------|------|------|
| remainingDraws | 整數 | 剩餘抽獎次數 |
| prizes | 陣列 | 獎品列表 |

**獎品欄位：**

| 欄位 | 類型 | 說明 |
|------|------|------|
| position | 整數 | 九宮格位置 |
| name | 字串 | 獎品名稱 |
| icon | 字串 | 獎品圖示 |
| type | 列舉 | 獎品類型 |

### 執行抽獎回應

| 欄位 | 類型 | 說明 |
|------|------|------|
| success | 布林 | 是否成功 |
| prize.position | 整數 | 中獎位置（前端動畫用） |
| prize.type | 列舉 | 獎品類型 |
| prize.value | 整數 | 獎品數值 |
| prize.name | 字串 | 獎品名稱 |
| remainingDraws | 整數 | 剩餘次數 |
| balance.lovePoints | 整數 | 愛心點數餘額 |
| balance.rewardPoints | 整數 | 獎勵積分餘額 |

### 抽獎記錄回應

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | 字串 | 記錄 ID |
| prizeType | 列舉 | 獎品類型 |
| prizeValue | 整數 | 獎品數值 |
| prizeName | 字串 | 獎品名稱 |
| createdAt | 時間 | 抽獎時間 |

### 後台抽獎記錄查詢

| 欄位 | 類型 | 必填 | 說明 |
|------|------|------|------|
| memberId | 字串 | 否 | 會員 ID |
| memberName | 字串 | 否 | 會員姓名 |
| memberPhone | 字串 | 否 | 會員手機 |
| prizeType | 列舉 | 否 | 獎品類型 |
| startDate | 時間 | 否 | 開始日期 |
| endDate | 時間 | 否 | 結束日期 |
| page | 整數 | 否 | 頁碼 |
| limit | 整數 | 否 | 每頁數量 |

---

## 前端動畫說明

### 九宮格轉盤位置對應

| 行 | 位置 |
|----|------|
| 第一行 | 0、1、2 |
| 第二行 | 7、X（開始按鈕）、3 |
| 第三行 | 6、5、4 |

**動畫順序：** 0 → 1 → 2 → 3 → 4 → 5 → 6 → 7 → 0 → ...（順時針轉動）

---

## 錯誤代碼

| 代碼 | 說明 |
|------|------|
| LTY_001 | 抽獎次數不足 |
| LTY_002 | 抽獎功能暫時關閉 |
| LTY_003 | 獎品發放失敗 |

---

## 相關模組

- [Member 會員系統](./member.md) - 抽獎會員
- [Point 點數系統](./point.md) - 點數/積分獎勵
