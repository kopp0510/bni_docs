# Auth 認證系統

## 模組資訊

| 項目 | 說明 |
|------|------|
| 模組名稱 | Auth |
| 開發階段 | Phase 1 |
| 複雜度 | 中 |
| 相依模組 | 無（基礎模組） |
| 被依賴 | 所有其他模組 |

---

## 功能概述

認證系統負責處理所有使用者的身份驗證與授權，包含客端會員登入與後台管理員登入。

---

## 功能清單

### 客端功能

| 功能 | 說明 |
|------|------|
| 手機號碼登入 | 使用手機號碼 + 驗證碼登入 |
| 會員註冊 | 新會員註冊流程 |
| 忘記密碼 | 重設密碼功能 |
| 登出 | 登出已登入帳號 |
| 刪除帳號 | 刪除已註冊帳號 |

### 後台功能

| 功能 | 說明 |
|------|------|
| 管理員登入 | 帳號密碼登入 |
| Token 管理 | JWT Token 發放與驗證 |

---

## API 端點設計

### 客端 API

| 方法 | 端點 | 說明 |
|------|------|------|
| POST | /api/v1/auth/send-otp | 發送驗證碼 |
| POST | /api/v1/auth/verify-otp | 驗證驗證碼 |
| POST | /api/v1/auth/register | 會員註冊 |
| POST | /api/v1/auth/login | 會員登入 |
| POST | /api/v1/auth/logout | 登出 |
| POST | /api/v1/auth/forgot-password | 忘記密碼 |
| POST | /api/v1/auth/reset-password | 重設密碼 |
| DELETE | /api/v1/auth/account | 刪除帳號 |
| POST | /api/v1/auth/refresh-token | 刷新 Token |

### 後台 API

| 方法 | 端點 | 說明 |
|------|------|------|
| POST | /api/v1/admin/auth/login | 管理員登入 |
| POST | /api/v1/admin/auth/logout | 管理員登出 |
| POST | /api/v1/admin/auth/refresh | 刷新 Token |

---

## 資料庫設計

### OTP 驗證碼表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | UUID | 主鍵 |
| phone | 字串 | 手機號碼 |
| code | 字串 | 驗證碼 |
| type | 列舉 | 類型：REGISTER（註冊）、LOGIN（登入）、RESET_PASSWORD（重設密碼） |
| expiresAt | 時間 | 過期時間 |
| verified | 布林 | 是否已驗證（預設 false） |
| attempts | 整數 | 嘗試次數（預設 0） |
| createdAt | 時間 | 建立時間 |

索引：phone + type

### 管理員表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | UUID | 主鍵 |
| username | 字串 | 帳號（唯一） |
| password | 字串 | 密碼（加密） |
| name | 字串 | 姓名 |
| email | 字串 | 電子郵件（選填） |
| isActive | 布林 | 是否啟用（預設 true） |
| lastLoginAt | 時間 | 最後登入時間 |
| createdAt | 時間 | 建立時間 |
| updatedAt | 時間 | 更新時間 |

### Token 黑名單表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | UUID | 主鍵 |
| token | 字串 | Token 值（唯一） |
| expiresAt | 時間 | 過期時間 |
| createdAt | 時間 | 建立時間 |

---

## 業務邏輯

### 註冊流程

| 步驟 | 說明 |
|------|------|
| 1 | 用戶選擇會員類型（個人/公益商家/商務） |
| 2 | 輸入手機號碼 |
| 3 | 系統發送 OTP 驗證碼 |
| 4 | 用戶輸入驗證碼驗證 |
| 5 | 設定密碼 |
| 6 | 填寫個人資料 |
| 7 | 電子簽名 |
| 8 | 同意隱私政策 |
| 9 | 註冊完成，進入待審核狀態 |

### 登入流程

| 步驟 | 說明 |
|------|------|
| 1 | 用戶輸入手機號碼 |
| 2 | 系統發送 OTP 驗證碼 |
| 3 | 用戶輸入驗證碼 |
| 4 | 驗證成功，發放 JWT Token |
| 5 | 返回用戶資訊與 Token |

### OTP 驗證碼規則

| 規則 | 說明 |
|------|------|
| 長度 | 6 位數字 |
| 有效期 | 5 分鐘 |
| 重試次數 | 最多 3 次 |
| 發送間隔 | 60 秒 |
| 每日上限 | 同一號碼每日最多 10 次 |

### JWT Token 規則

| 規則 | 說明 |
|------|------|
| Access Token 有效期 | 2 小時 |
| Refresh Token 有效期 | 7 天 |
| 加密演算法 | RS256 |

---

## SMS 簡訊服務

### OTP 發送流程

| 步驟 | 說明 |
|------|------|
| 1 | 檢查發送頻率（60 秒內不可重複發送） |
| 2 | 檢查每日發送上限（10 次） |
| 3 | 生成 6 位數驗證碼 |
| 4 | 儲存 OTP 記錄（設定 5 分鐘過期） |
| 5 | 發送簡訊 |

### OTP 驗證流程

| 步驟 | 說明 |
|------|------|
| 1 | 查詢未過期、未驗證的 OTP 記錄 |
| 2 | 檢查是否存在有效記錄 |
| 3 | 檢查重試次數（不超過 3 次） |
| 4 | 比對驗證碼 |
| 5 | 驗證成功則標記為已驗證；失敗則增加嘗試次數 |

### SMS 服務商整合

系統預留 SMS 服務商介面，可彈性切換不同供應商：

| 服務商 | 說明 |
|--------|------|
| 三竹簡訊 | 台灣本地簡訊服務 |
| Twilio | 國際簡訊服務 |
| AWS SNS | Amazon 簡訊服務 |

### 簡訊內容範本

| 類型 | 簡訊內容 |
|------|----------|
| 註冊 | 【商脈會】您的註冊驗證碼為 {code}，5分鐘內有效，請勿洩漏給他人。 |
| 登入 | 【商脈會】您的登入驗證碼為 {code}，5分鐘內有效。 |
| 重設密碼 | 【商脈會】您的密碼重設驗證碼為 {code}，5分鐘內有效。 |

---

## DTO 資料格式

### 發送驗證碼

| 欄位 | 類型 | 說明 |
|------|------|------|
| phone | 字串 | 手機號碼 |
| type | 列舉 | REGISTER / LOGIN / RESET_PASSWORD |

### 驗證驗證碼

| 欄位 | 類型 | 說明 |
|------|------|------|
| phone | 字串 | 手機號碼 |
| code | 字串 | 驗證碼 |
| type | 列舉 | REGISTER / LOGIN / RESET_PASSWORD |

### 會員註冊

| 欄位 | 類型 | 必填 | 說明 |
|------|------|------|------|
| phone | 字串 | 是 | 手機號碼 |
| password | 字串 | 是 | 密碼 |
| memberType | 列舉 | 是 | PERSONAL / PUBLIC_MERCHANT / BUSINESS |
| name | 字串 | 是 | 姓名 |
| email | 字串 | 否 | 電子郵件 |
| organizationId | 字串 | 是 | 所屬商會 ID（必填，會員必須歸屬於某商會） |
| referrerId | 字串 | 否 | 推薦人 ID |
| signature | 字串 | 是 | 電子簽名（Base64 圖片） |
| agreePrivacy | 布林 | 是 | 同意隱私政策 |

### 登入請求

| 欄位 | 類型 | 說明 |
|------|------|------|
| phone | 字串 | 手機號碼 |
| code | 字串 | OTP 驗證碼 |

### 登入回應

| 欄位 | 類型 | 說明 |
|------|------|------|
| accessToken | 字串 | 存取權杖 |
| refreshToken | 字串 | 更新權杖 |
| expiresIn | 整數 | 有效秒數 |
| user.id | 字串 | 使用者 ID |
| user.name | 字串 | 姓名 |
| user.phone | 字串 | 手機號碼 |
| user.memberType | 列舉 | 會員類型 |
| user.status | 列舉 | 會員狀態 |

### 管理員登入

| 欄位 | 類型 | 說明 |
|------|------|------|
| username | 字串 | 帳號 |
| password | 字串 | 密碼 |

---

## 安全考量

| 項目 | 說明 |
|------|------|
| 密碼加密 | 使用 bcrypt 加密存儲（cost factor: 12） |
| OTP 防暴力破解 | 限制重試次數（3次）與發送頻率（60秒） |
| Token 黑名單 | 登出後 Token 加入黑名單 |
| Rate Limiting | API 請求頻率限制 |
| HTTPS | 所有通訊使用 HTTPS |
| 手機號碼格式驗證 | 僅接受台灣手機號碼格式（09xxxxxxxx） |

---

## 錯誤代碼

| 代碼 | 說明 |
|------|------|
| AUTH_001 | 驗證碼錯誤 |
| AUTH_002 | 驗證碼已過期 |
| AUTH_003 | 驗證碼發送過於頻繁 |
| AUTH_004 | 手機號碼已註冊 |
| AUTH_005 | 帳號不存在 |
| AUTH_006 | 密碼錯誤 |
| AUTH_007 | Token 無效或已過期 |
| AUTH_008 | 帳號已被停用 |
| AUTH_009 | 帳號待審核中 |
| AUTH_010 | 今日驗證碼發送次數已達上限 |
| AUTH_011 | 驗證碼錯誤次數過多 |
| AUTH_012 | 手機號碼格式錯誤 |
| AUTH_013 | 簡訊發送失敗 |

---

## 相關模組

- [Member 會員系統](./member.md) - 會員資料管理
- [Organization 商會管理](./organization.md) - 商會歸屬
